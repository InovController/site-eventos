{% extends 'event_nav.html' %}
{% load static %}

{% block title %}Dashboard{% endblock %}

{% block content %}
    <style>
        .rotate-icon {
            transition: transform 0.5s ease;
        }

        .rotate-icon-up {
            transform: rotate(90deg);
        }

        .rotate-icon-down {
            transform: rotate(0deg);
        }
        
        .chart-card {
            min-height: 420px;
            display: flex;
            flex-direction: column;
        }

        .chart-container {
            flex: 1;
            position: relative;
            min-height: 300px;
            max-height: 350px;
        }

        .chart-container canvas {
            width: 100% !important;
            height: auto !important;
            max-height: 100%;
        }
    </style>
    <div class="page-header">
        <h4 class="page-title fs-3">Dashboard</h4>
        <ul class="breadcrumbs">
            <li class="nav-home">
                <a href="#">
                    <i class="icon-home"></i>
                </a>
            </li>
            <li class="separator">
                <i class="icon-arrow-right"></i>
            </li>
            <li class="nav-item">
                <a href="{% url 'event_detail' object.pk %}">{{ object.title|title }}</a>
            </li>
            <li class="separator">
                <i class="icon-arrow-right"></i>
            </li>
            <li class="nav-item">
                <a href="#">Dashboard</a>
            </li>
        </ul>
    </div>
    <div class="page-category">
        Verifique abaixo gráficos para entender melhor a avaliação comportamental e aceitação do público sobre o evento.
    </div>
    {% if not numeric_questions_by_theme and not text_questions_by_theme %}
        <div class="alert alert-info">
            Nenhuma avaliação foi encontrada para este evento.
        </div>
    {% else %}
        <div class="mb-3">
            <button id="exportPdfBtn" class="btn btn-outline-primary" 
                onclick="exportChartsToPDF(this)" 
                data-event-title="{{ object.title }}">
            <i class="fas fa-file-pdf"></i> Exportar Gráficos em PDF
        </button>
        </div>
    {% endif %}
    <div class="row">
        {% for theme, questions in numeric_questions_by_theme.items %}
            <div class="col-md-6">
                <div class="card chart-card">
                    <div class="card-header">
                        <div class="card-title">{{ theme }}</div>
                        <div class="card-subtitle py-1">Media Geral das Respostas</div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="barChart-{{ forloop.counter }}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <div id="pieChartTitle-{{ forloop.counter }}" class="card-title">{{ theme }}</div>
                        <div class="card-subtitle py-1">Porcentagem de Cada Resposta</div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container">
                            <canvas id="pieChart-{{ forloop.counter }}"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        {% endfor %}

        <!-- Exibir respostas textuais -->
        {% for theme, questions in text_questions_by_theme.items %}
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4 class="card-title">{{ theme }}</h4>
                    </div>
                    <div class="card-body mt-2">
                        <!-- Para cada pergunta dentro do tema -->
                        {% for question in questions %}
                            <div class="collapse-header mb-4">
                                <a href="#collapse-{{ question|slugify }}" data-bs-toggle="collapse" aria-expanded="true" onclick="toggleIcon(this)">
                                    <h5 class="text-academy-green  mb-3"><i class="fas fa-angle-right rotate-icon rotate-icon-down"></i> {{ question.question_text }}</h5>
                                </a>
                            </div>
                            <div id="collapse-{{ question|slugify }}" class="collapse response-container">
                                <!-- Listando cada resposta textual -->
                                {% for answer in question.answers %}
                                    <div class="response-card mx-3">
                                        <span class="response-text mt-0 fs-6">{{ answer }}</span>
                                    </div>
                                    <hr class="response-separator mt-2 pt-2 {% if forloop.last %}mb-4{% endif %} mx-2">
                                {% endfor %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    </div>
{% endblock %}

{% block end-js %}
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        let isExportingPDF = false;

        function toggleIcon(element) {
            var icon = element.querySelector('i');
            icon.classList.toggle('rotate-icon-up');
            icon.classList.toggle('rotate-icon-down');
        }
        
        function generateColorPalette(size) {
            const contrastColors = [
                "#2E86AB", "#F6C85F", "#6F4E7C", "#FF6F61", "#955251",
                "#00A896", "#FFA69E", "#BC5090", "#4A4E69", "#88CCEE"
            ];
            return Array.from({ length: size }, (_, i) => contrastColors[i % contrastColors.length]);
        }
                
        const fixedPieColors = [
            "#e57373", "#ffb74d", "#fff176", "#aed581", "#4db6ac"
        ];

        {% for theme, questions in numeric_questions_by_theme.items %}
            (function() {
                let fullLabels = [{% for question in questions %}"{{ question.question_text }}"{% if not forloop.last %}, {% endif %}{% endfor %}];
                let labels = [{% for question in questions %} "{{ question.question_text|slice:":10" }}...", {% endfor %}];
                
                let data = [{% for question in questions %} parseFloat("{{ question.avg_score|floatformat:2 }}".replace(',', '.')){% if not forloop.last %}, {% endif %}{% endfor %}];

                let barColors = generateColorPalette(labels.length);
                let pieColors = fixedPieColors;
                
                let responseDistributions = [
                    {% for question in questions %}
                        {
                            labels: [1, 2, 3, 4, 5],
                            data: [
                                {{ question.distribution.1 }},
                                {{ question.distribution.2 }},
                                {{ question.distribution.3 }},
                                {{ question.distribution.4 }},
                                {{ question.distribution.5 }}
                            ]
                        }{% if not forloop.last %},{% endif %}
                    {% endfor %}
                ];

                var pieChartTitle = document.getElementById('pieChartTitle-{{ forloop.counter }}')
                pieChartTitle.textContent = fullLabels[0];
                
                let ctxPie = document.getElementById('pieChart-{{ forloop.counter }}').getContext('2d');
                let pieChart = new Chart(ctxPie, {
                    type: 'pie',
                    data: {
                        labels: responseDistributions[0].labels,
                        datasets: [{
                            data: responseDistributions[0].data,
                            backgroundColor: pieColors,
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: {
                                    usePointStyle: true,
                                    pointStyle: 'circle',
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        var dataset = tooltipItems[0].dataset;
                                        var currentValue = dataset.data[tooltipItems[0].dataIndex];
                                        return 'Quantidade: ' + currentValue;
                                    },
                                    label: function(tooltipItem) {
                                        const label = tooltipItem.label;
                                        return 'Nota: ' + label;
                                    }
                                }
                            },
                            datalabels: {
                                formatter: (value, context) => {
                                    let total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    let percentage = (value / total * 100).toFixed(1);

                                    if (percentage < 5) return '';

                                    let label = context.chart.data.labels[context.dataIndex];
                                    return percentage + '%' + "\n" + "Nota: " + label;
                                },
                                color: '#fff',
                                font: {
                                    size: '14'
                                }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });

                let ctxBar = document.getElementById('barChart-{{ forloop.counter }}').getContext('2d');
                let barChart = new Chart(ctxBar, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            data: data,
                            backgroundColor: barColors,
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        var idx = tooltipItems[0].dataIndex;
                                        return fullLabels[idx];
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 5
                            }
                        },
                        onClick: function(evt, activeElements) {
                            if (activeElements.length > 0) {
                                var index = activeElements[0].index;
                                pieChart.data.datasets[0].data =[0, 0, 0, 0, 0];
                                pieChart.update();

                                setTimeout(() => {
                                    pieChart.data.datasets[0].data = responseDistributions[index].data;

                                    pieChart.update();
                                }, 250);

                                pieChartTitle.textContent = fullLabels[index];
                            }
                        }
                    }
                });
            })();
        {% endfor %}

        async function exportChartsToPDF(button) {
            const btn = document.getElementById('exportPdfBtn');
            btn.disabled = true;
            btn.innerHTML = `<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Gerando PDF...`;
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');
            const title = button.getAttribute('data-event-title') || 'Relatório';
            const margin = 15;
            const maxTextWidth = 180;
            const pageHeight = 297;

            let y = margin;
            
            pdf.setFont('helvetica', 'bold');
            pdf.setFontSize(18);
            const splitTitle = pdf.splitTextToSize(title.toUpperCase(), maxTextWidth);
            pdf.text(splitTitle, margin, y);
            y += splitTitle.length * 6 + 6;

            const charts = document.querySelectorAll('canvas');

            for (let i = 0; i < charts.length; i += 2) {
                if (i > 0) {
                    pdf.addPage();
                    y = margin;
                }

                for (let j = 0; j < 2; j++) {
                    const canvas = charts[i + j];
                    if (!canvas) continue;

                    const card = canvas.closest('.card');
                    const titleEl = card?.querySelector('.card-title');
                    const subtitleEl = card?.querySelector('.card-subtitle');
                    const chartTitle = titleEl?.innerText?.trim() || `Gráfico ${i + j + 1}`;
                    const chartSubtitle = subtitleEl?.innerText?.trim() || '';

                    pdf.setFont('helvetica', 'bold');
                    pdf.setFontSize(14);
                    const splitChartTitle = pdf.splitTextToSize(chartTitle, maxTextWidth);
                    pdf.text(splitChartTitle, margin, y);
                    y += splitChartTitle.length * 6;

                    if (chartSubtitle) {
                        pdf.setFont('helvetica', 'normal');
                        pdf.setFontSize(11);
                        pdf.setTextColor(100);
                        const splitChartSubtitle = pdf.splitTextToSize(chartSubtitle, maxTextWidth);
                        pdf.text(splitChartSubtitle, margin, y);
                        y += splitChartSubtitle.length * 6;
                        pdf.setTextColor(0);
                    }
                    
                    const canvasImage = await html2canvas(canvas, {
                        scale: 4,
                        backgroundColor: "#fff",
                        useCORS: true
                    });

                    const imgData = canvasImage.toDataURL('image/png');
                    const imgProps = pdf.getImageProperties(imgData);
                    const pdfWidth = 180;
                    const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;

                    if (y + pdfHeight > pageHeight - margin) {
                        pdf.addPage();
                        y = margin;
                    }

                    pdf.addImage(imgData, 'PNG', margin, y, pdfWidth, pdfHeight);
                    y += pdfHeight + (j === 0 ? 20 : 10);
                }
            }

            btn.disabled = false;
            btn.innerHTML = `<i class="fas fa-file-pdf"></i> Exportar Gráficos em PDF`;
            pdf.save(`${title.toLowerCase().replace(/\s/g, "_")}_graficos.pdf`);
        }
    </script>
{% endblock %}
